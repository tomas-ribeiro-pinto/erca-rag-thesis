<!--
    ================================================================================
    RAG Chatbot API for Education - Thesis Project
    --------------------------------------------------------------------------------
    Author: GitHub Copilot and TomÃ¡s Pinto
    Date: August 2025
    Description:
        This file is a chatbot user interface generated by GitHub Copilot in VS Code.
        It is part of the RAG Chatbot API for Education - Thesis Project and allows to
        interact with the chatbot using a GUI.
    ================================================================================
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Message Form</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #f9f9f9;
            padding-bottom: 80px;
        }
        .message-form {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #fff;
            padding: 10px;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
            display: flex;
            gap: 8px;
        }
        .message-input {
            flex: 1;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }
        .send-btn {
            padding: 0 18px;
            background: #007bff;
            color: #fff;
            border: none;
            border-radius: 20px;
            font-size: 16px;
            cursor: pointer;
        }
        .send-btn:active {
            background: #0056b3;
        }
        .send-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .chat-message {
            margin: 16px;
            padding: 12px;
            border-radius: 12px;
            max-width: 80%;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .user-message {
            background: #007bff;
            color: white;
            margin-left: auto;
            margin-right: 16px;
        }
        .bot-message {
            background: #e9ecef;
            color: #333;
        }
        .streaming-message {
            background: #e9ecef;
            color: #333;
            /* background: #d4d4d4;
            color: #333;
            border-top: 3px solid #2e2e2e;
            border-bottom: 3px solid #2e2e2e; */

        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        #chat-container {
            max-height: calc(100vh - 80px);
            overflow-y: auto;
        }
        .typing-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #2e2e2e;
            animation: typing 2s infinite ease-in-out;
        }
        .typing-indicator:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div id="chat-container">
        <!-- Chat history will be loaded here -->
    </div>
    <form class="message-form" id="messageForm">
        <input type="text" class="message-input" id="messageInput" placeholder="Type your message..." autocomplete="off" />
        <button type="submit" class="send-btn" id="sendBtn">Send</button>
    </form>
    <script>
        var chatbot_id = '{{ chatbot_id }}';
        var user_email = '{{ user_email }}';
        const form = document.getElementById('messageForm');
        const input = document.getElementById('messageInput');
        const chatContainer = document.getElementById('chat-container');
        const sendBtn = document.getElementById('sendBtn');

        // Load chat history on page load
        async function loadChatHistory() {
            try {
                const response = await fetch(`/api/chatbot/${chatbot_id}/history`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_email: user_email
                    })
                });
                const data = await response.json();
                
                if (response.ok && data.history) {
                    data.history.forEach(message => {
                        addMessageToChat(message.content, message.role);
                    });
                }
            } catch (error) {
                console.error('Failed to load chat history:', error);
            }
        }

        // Add message to chat display
        function addMessageToChat(content, role) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role === 'user' ? 'user-message' : 'bot-message'}`;
            messageDiv.textContent = content;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return messageDiv;
        }

        // Add streaming message container
        function addStreamingMessage() {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message streaming-message';
            messageDiv.id = 'streaming-message';
            messageDiv.innerHTML = '<span class="typing-indicator"></span><span class="typing-indicator"></span><span class="typing-indicator"></span>';
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return messageDiv;
        }

        // Update streaming message content
        function updateStreamingMessage(content) {
            const streamingDiv = document.getElementById('streaming-message');
            if (streamingDiv) {
                streamingDiv.textContent = content;
            }
        }

        // Finalize streaming message
        function finalizeStreamingMessage() {
            const streamingDiv = document.getElementById('streaming-message');
            if (streamingDiv) {
                streamingDiv.className = 'chat-message bot-message';
                streamingDiv.id = '';
            }
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'chat-message error';
            errorDiv.textContent = `Error: ${message}`;
            chatContainer.appendChild(errorDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Stream response using POST with Server-Sent Events
        async function streamResponse(userMessage) {
            return new Promise(async (resolve, reject) => {
                // Create streaming message container
                const streamingDiv = addStreamingMessage();
                let accumulatedResponse = '';

                try {
                    const response = await fetch(`/api/chatbot/${chatbot_id}/prompt`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'text/event-stream',
                        },
                        body: JSON.stringify({
                            user_email: user_email,
                            prompt: userMessage
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();

                    while (true) {
                        const { done, value } = await reader.read();
                        
                        if (done) {
                            finalizeStreamingMessage();
                            resolve(accumulatedResponse);
                            break;
                        }

                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n');

                        for (const line of lines) {
                            if (line.trim() && line.startsWith('data: ')) {
                                try {
                                    const jsonData = line.substring(6); // Remove 'data: ' prefix
                                    const data = JSON.parse(jsonData);
                                    
                                    if (data.chunk) {
                                        accumulatedResponse += data.chunk;
                                        updateStreamingMessage(accumulatedResponse);
                                    } else if (data.done) {
                                        finalizeStreamingMessage();
                                        resolve(accumulatedResponse);
                                        return;
                                    } else if (data.error) {
                                        streamingDiv.remove();
                                        showError(data.error);
                                        reject(new Error(data.error));
                                        return;
                                    }
                                } catch (parseError) {
                                    console.warn('Failed to parse SSE line:', line);
                                }
                            }
                        }
                    }
                } catch (error) {
                    streamingDiv.remove();
                    showError(error.message);
                    reject(error);
                }
            });
        }

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            const userMessage = input.value.trim();
            
            if (userMessage) {
                // Add user message to chat
                addMessageToChat(userMessage, 'user');
                
                // Disable form while processing
                sendBtn.disabled = true;
                input.disabled = true;
                input.value = "";
                
                try {
                    // Use SSE streaming
                    await streamResponse(userMessage);
                } catch (error) {
                    console.error('Streaming failed:', error);
                } finally {
                    // Re-enable form
                    sendBtn.disabled = false;
                    input.disabled = false;
                    input.focus();
                }
            }
        });

        // Load chat history when page loads
        window.addEventListener('load', loadChatHistory);
    </script>
</body>
</html>